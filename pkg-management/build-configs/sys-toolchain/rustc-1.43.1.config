# 1 >> extarct the tarball
tar xf /mss/work/sauces/rustc-1.43.1-src.tar.xz
cd rustc-1.43.1-src/

# 2
cache_dir=build/cache/2020-03-12
mkdir -pv "$cache_dir"

cp -v \
 /mss/work/sauces/cargo-0.43.0-x86_64-unknown-linux-musl.tar.xz    \
 /mss/work/sauces/rust-std-1.42.0-x86_64-unknown-linux-musl.tar.xz \
 /mss/work/sauces/rustc-1.42.0-x86_64-unknown-linux-musl.tar.xz    \
"$cache_dir"

# 4 >> patch for musl, llvm 10 and libressl 3.2.0
pdir="/mss/repo/pkg-management/patches/rustc-1.43.1"
patch -p1 < "${pdir}"/libressl-3.2.patch
patch -p1 < "${pdir}"/llvm10.patch
patch -p1 < "${pdir}"/musl.patch

# 5 >> exports and extracts for libllvm
pushd /opt
doas -- tar xfp \
 /mnt/mss/stuff/techy-bits/packaged-software/llvm-clang-10.0.0.tar
popd

export            PATH="/opt/llvm-10.0.0/bin:$PATH"
export    LIBRARY_PATH="/opt/llvm-10.0.0/lib"
export LD_LIBRARY_PATH="${LIBRARY_PATH}"

[ ! "$(llvm-config --libdir)" = "${LIBRARY_PATH}" ] \
 && printf "suck my asshole.\n"

# 6 >> remove checksums
for vendor in libc openssl-sys; do
 sed -i 's/\("files":{\)[^}]*/\1/' "vendor/$vendor/.cargo-checksum.json"
done

# 7 >> echo the config
cat > config.toml <<EOF
[llvm]
link-shared = true

[build]
build  = "x86_64-unknown-linux-musl"
host   = [ "x86_64-unknown-linux-musl" ]
target = [ "x86_64-unknown-linux-musl" ]

docs           = false
compiler-docs  = false
extended       = true
submodules     = false
python         = "python3"
locked-deps    = true
vendor         = true
sanitizers     = false
profiler       = false
full-bootstrap = false

[install]
prefix = "/opt/rustc-1.43.1"

[rust]
channel          = "stable"
rpath            = false
codegen-units    = 1
debuginfo-level  = 0
debug            = false
backtrace        = false
jemalloc         = false
debug-assertions = false
codegen-tests    = false

[target.x86_64-unknown-linux-musl]
llvm-config = "/opt/llvm-10.0.0/bin/llvm-config"
crt-static  = false
EOF

# 8 >> build
/bin/busybox time \
 python3 ./x.py build -j 2

# 9 >> install
# that x.py shit fails to do a destdir install if prefix
# is missing in the real system. state of the art build 
# system everybody.
doas -- mkdir -pv "/opt/rustc-1.43.1"

instdir="${PWD}"/KEK
DESTDIR="${instdir}" python3 ./x.py install

# 10 >> clean up
rm -rfv \
 "${instdir}"/etc                                                             \
 "${instdir}"/opt/rustc-1.43.1/share                                          \ 
 "${instdir}"/opt/rustc-1.43.1/lib/rustlib/src                                \ 
 "${instdir}"/opt/rustc-1.43.1/lib/rustlib/x86_64-unknown-linux-musl/analysis

cd "${instdir}"/opt/rustc-1.43.1/lib/rustlib
rm -rfv \
 components   \
 install.log  \
 manifest-*   \
 uninstall.sh \
 rust-installer-version

# 11 >> strip
cd "${instdir}"/opt/rustc-1.43.1/bin
strip --strip-all -v *

cd "${instdir}"/opt/rustc-1.43.1/lib
find . -type f -name \*.so   -exec strip --strip-unneeded -v {} ';'
find . -type f -name \*.rlib -exec strip --strip-debug    -v {} ';'
