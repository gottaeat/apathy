#!/mss/bin/sh
# 0 > include device specific vars
. /mss/files/init.conf

# 1 > service specific functions
# 1.1 > nfs
stopnfsbase(){
 ainitsvc "nfs" "stopping rpcbind"
 ainit_kill rpcbind

 ainitsvc "nfs" "stopping rpc.statd"
 ainit_kill rpc.statd
 if [ -f /var/run/rpc.statd.pid ]; then rm -f /var/run/rpc.statd.pid; fi
}

startnfsbase(){
 ainitsvc "nfs" "starting rpcbind"
  rpcbind
 evalret

 ainitsvc "nfs" "starting rpc.statd"
  rpc.statd -p 31310 -o 31311 --no-notify
 evalret
}

# 1.2 > swap
checkswaps(){
 if [ "$(wc -l /proc/swaps | awk '{print $1}')" -gt 1 ]
  then
   ainitsvc "swap" "found active swap(s), disabling"
    swapoff -a >/dev/null 2>&1
   evalret
  else
   ainitsvc "swap" "no active swaps found"; infoprompt
 fi

 if [ ! "$(cat /sys/block/zram0/size)" -eq 0 ]; then
  ainitsvc "swap" "resetting zram"
   echo "1" > /sys/block/zram0/reset
  evalret
 fi
}

# 2 > services themselves
# 2.1 > gpm
svc_gpm(){
case "$1" in
 start)
  ainitsvc "gpm" "starting"
   gpm -m /dev/input/mice -t imps2 >/dev/null 2>&1
  evalret
 ;;
 stop)
  ainitsvc "gpm" "stopping"
  ainit_kill gpm
 ;;
 *)
  ainitusage "{start|stop}"
  exit 1
 ;;
esac
}

# 2.2 > iptables
svc_iptables(){
 case "$1" in
  start)
   ainitsvc "iptables" "setting the rules"
    . /mss/init/files/iptables.script
   evalret

   ainitsvc "iptables" "starting nfqws"
    nfqws --uid=0:0 \
     --qnum=200 --dpi-desync-fwmark=0x40000000 --wssize=1:6 \
     --hostcase --hostspell=hoST --hostnospace --domcase    \
     --dpi-desync=fake           \
     --dpi-desync-fooling=md5sig \
     --dpi-desync-retrans=1      \
     --dpi-desync-skip-nosni=0   \
     --dpi-desync-ttl=6 >/dev/null 2>&1 &
   evalret
  ;;
  stop)
   ainitsvc "iptables" "clearing the rules"
    iptables --policy INPUT   ACCEPT  &&
    iptables --policy OUTPUT  ACCEPT  &&
    iptables --policy FORWARD ACCEPT  &&
    iptables --flush                  &&
    iptables -t mangle --flush        &&
    iptables --delete-chain           &&
    iptables -t mangle --delete-chain
   evalret

   ainitsvc "iptables" "stopping nfqws"
   ainit_kill nfqws
  ;;
  status)
   iptables --numeric --list
   iptables -t mangle --numeric --list
  ;;
  *)
   ainitusage "{start|stop|status}"
   exit 1
  ;;
 esac
}

# 2.3 > mpd
svc_mpd(){
 case "$1" in
  start)
   if [ -d "$(awk '/music_directory/{gsub(/\"/,""); print $2}' /etc/mpd.conf)" ]
    then
     ainitsvc "mpd" "starting mpd"
      doas -u mss mpd /etc/mpd.conf >/dev/null 2>&1
     evalret

     ainitsvc "mpd" "setting up"
      mpc repeat  on  >/dev/null 2>&1 &&
      mpc random  off >/dev/null 2>&1 &&
      mpc single  off >/dev/null 2>&1 &&
      mpc consume off >/dev/null 2>&1 &&
      mpc disable only "$(mpc outputs | awk '/http/{print $2}')" >/dev/null 2>&1
     evalret

     ainitsvc "mpd" "starting ympd"
      doas -u mss ympd >/dev/null 2>&1 &
     evalret

     ainitsvc "mpd" "starting mpdas"
      doas -u mss mpdas >/dev/null 2>&1 &
     evalret
    else
     ainitsvc "mpd" "music_directory does not exist"; failprompt
     exit 1
   fi
  ;;
  stop)
   ainitsvc "mpd" "stopping ympd"
   ainit_kill ympd

   ainitsvc "mpd" "stopping mpdas"
   ainit_kill mpdas

   ainitsvc "mpd" "stopping mpd"
   ainit_kill mpd
  ;;
  *)
   ainitusage "{start|stop}"
   exit 1
  ;;
 esac
}

# 2.4 > network
svc_network(){
case "${1}" in
 start)
  if [ -z "${2}" ]
   then
    ainitsvc "network" "specify an interface with \$2"; failprompt
    exit 1
   else
    iface="${2}"

    if ! ip addr | awk '/^[0-9]/{gsub(/:/,""); print $2}' | grep -w "${iface}" >/dev/null 2>&1; then
     ainitsvc "network" "interface ${iface} does not exist"; failprompt
     exit 1
    fi

    case "${iface}" in wlan*)
     if [ -z "${4}" ]
      then
       ainitsvc "network" "specify a wpaconf with \$4"; failprompt
       exit 1
      else
       wpaconf="/mss/files/networks/${4}.conf"

       if [ ! -f "${wpaconf}" ]; then
        ainitsvc "network" "${wpaconf} does not exist"; failprompt
        exit 1
       fi
     fi
    ;;
    esac
  fi

  if [ -z "${3}" ]
   then
    ainitsvc "network" "specify a method: {dhcp|static} with \$3"; failprompt
    exit 1
   else
    case ${3} in
     dhcp|static) method="${3}" ;;
     *)
      ainitsvc "network" "input either dhcp or static"; failprompt
      exit 1
     ;;
    esac
  fi

  if ip addr | grep ${iface} | grep inet >/dev/null 2>&1; then
   ainitsvc "network" "${iface} already has an ip assinged"; failprompt
   exit 1
  fi

  case "${method}" in dhcp)
   randommac="$(hexdump -n3 -e'/3 "00:60:2F" 3/1 ":%02X"' /dev/urandom)"

   ainitsvc "network" "setting mac for ${iface} to ${randommac}"
    ip link set dev "${iface}" address "${randommac}" >/dev/null 2>&1
   evalret
  esac

  case "${iface}" in
   usb*)
    ainitsvc "network" "bringing ${iface} up"
     ip link set "${iface}" up
    evalret
   ;;
   wlan*)
    ainitsvc "network" "invoking wpa_supplicant"
     wpa_supplicant -B -i "${iface}" -c "${wpaconf}" >/dev/null 2>&1
    evalret
   ;;
  esac

  case "${method}" in
   static)
    ainitsvc "network" "adding ${dev_sip} to ${iface}"
     ip addr add "${dev_sip}/${dev_pref}" broadcast "${dev_bcast}" dev "${iface}"
    evalret

    ainitsvc "network" "bringing ${iface} up"
     ip link set "${iface}" up
    evalret

    ainitsvc "network" "setting up the default gateway"
     ip route add default via "${dev_gway}" dev "${iface}"
    evalret
   ;;
   dhcp)
    ainitsvc "network" "invoking udhcpc"
     udhcpc \
      -i "${iface}" \
      -s "/mss/init/files/udhcpc.script" \
      -p "/run/udhcpc.pid"               \
      -B                                 \
      -t 30 -T 2                         \
      -n                                 \
      -R                                 \
      -a                                 \
      -S >/dev/null 2>&1 &
    evalret
   ;;
  esac
 ;;
 stop)
  if [ -z "${2}" ]
   then
    ainitsvc "network" "specify an interface with \$2"; failprompt
    exit 1
   else
    iface="${2}"

    if ip addr | grep ${iface} | grep inet >/dev/null 2>&1
     then
      ainitsvc "network" "flushing ${iface}"
       ip -4 addr flush dev "${iface}"
      evalret

      ainitsvc "network" "bringing down ${iface}"
       ip link set "${iface}" down
      evalret
     else
      ainitsvc "network" "${iface} does not have an ip assinged"; failprompt
    fi

    dhcpid="$(pidof udhcpc 2>/dev/null)"
    if [ ! -z "${dhcpid}" ]; then
     ainitsvc "network" "stopping udhcpc"
      for i in ${dhcpid}; do kill -USR2 "${i}"; done
     evalret

     sleep 1

     ainitsvc "network" "killing udhcpc"
     ainit_kill udhcpc
    fi

    if pidof wpa_supplicant >/dev/null 2>&1; then 
     ainitsvc "network" "killing wpa_supplicant"
     ainit_kill wpa_supplicant
    fi
  fi
 ;;
 *)
  ainitusage "{start|stop} {iface} {dhcp|static} | {wpaconf}"
  exit 1
 ;;
esac
}

# 2.5 > nfs
svc_nfs(){
 case "$1" in
  start)
   case "${2}" in
    server)
     if [ ! -f /etc/exports ]
      then
       ainitmes "/etc/exports does not exist."; failprompt
       exit 1
     elif [ "$(cat /etc/exports | wc -l)" -eq 0 ]
      then
       ainitmes "/etc/exports is empty."; failprompt
       exit 1
     fi

     startnfsbase 

     ainitsvc "nfs" "starting rpc.nfsd"
      rpc.nfsd -p 2049 "${nfs_threads}"
     evalret

     ainitsvc "nfs" "starting rpc.mountd"
      rpc.mountd -p 31312
     evalret

     ainitsvc "nfs" "running exportfs"
      exportfs -ra >/dev/null 2>&1
     evalret
    ;;
    client)
     startnfsbase
    ;;
    *)
     ainitmes "specify either client or server as \$2."; failprompt
     exit 1
    ;;
   esac
  ;;
  stop)
   case "${2}" in
    server)
     ainitsvc "nfs" "clearing exportfs"
      exportfs -au >/dev/null 2>&1
     evalret

     stopnfsbase     

     ainitsvc "nfs" "stopping kernel nfsd instances"
     ainit_kill nfsd kernel

     ainitsvc "nfs" "stopping rpc.mountd"
     ainit_kill rpc.mountd
    ;;
    client)
     stopnfsbase
    ;;
    *)
    ainitmes "specify either client or server as \$2."; failprompt
    exit 1
    ;;
   esac
  ;;
  reload)
   if [ -z "$(pgrep nfsd)" ]
    then
     ainitmes "no nfsd kernel threads found."; failprompt
     exit 1
    else
     ainitsvc "nfs" "reloading exportfs"
      exportfs -ra >/dev/null 2>&1
     evalret
   fi
  ;;
  *)
   ainitusage "{start|stop}"
   exit 1
  ;;
 esac
}

# 2.6 > ntpd
svc_ntpd(){
 case "$1" in
  start)
   ainitsvc "ntpd" "setting the time"
    ntpd -n -q >/dev/null 2>&1 &
   evalret
   ainitsvc "ntpd" "sys -> hwclock"
    hwclock -w
   evalret
  ;;
  stop)
   ainitsvc "ntpd" "sys -> hwclock"
    hwclock -w
   evalret
  ;;
  *)
   ainitusage "{start|stop}"
   exit 1
  ;;
 esac
}

# 2.7 > sshd
svc_sshd(){
 case "$1" in
  start)
   ainitsvc "sshd" "starting"
    /usr/bin/sshd >/dev/null 2>&1
   evalret
  ;;
  stop)
   ainitsvc "sshd" "stopping"
   ainit_kill sshd
  ;;
  *)
   ainitusage "{start|stop}"
   exit 1
  ;;
 esac
}

# 2.8 > thinkfan
svc_thinkfan(){
 case "$1" in
  start)
   ainitsvc "thinkfan" "starting"
    thinkfan -s 5 -n -q >/dev/null 2>&1 &
   evalret
  ;;
  stop)
   ainitsvc "thinkfan" "stopping"
   ainit_kill thinkfan
  ;;
  *)
   ainitusage "{start|stop}"
   exit 1
  ;;
 esac
}

# 2.9 > transmision
svc_transmission(){
 case "$1" in
  start)
   ainitsvc "transmission" "starting"
    doas -u mss \
     transmission-daemon \
     -g /home/mss/.config/transmission-daemon \
     --allowed "127.0.0.1,192.168.*.*"        \
     --port    "9091"                         \
     --no-auth                                \
     --no-watch-dir                           \
     --no-incomplete-dir                      \
     --dht                                    \
     --utp                                    \
     --paused                                 \
     --portmap                                \
     --global-seedratio 0                     \
     --pid-file "/run/transmission.pid"
   evalret
  ;;
  stop)
   ainitsvc "transmission" "stopping"
   ainit_kill transmission-daemon
  ;;
  *)
   ainitusage "{start|stop}"
   exit 1
  ;;
 esac
}

# 2.10 > swap
svc_swap(){
 case "$1" in
  start)
   case "$2" in
    zram)
     checkswaps

     ainitsvc "swap" "setting up sysfs/procfs for zram as swap"
      echo "${zram_dsize}" > /sys/block/zram0/disksize       &&
      echo "${zram_limit}" > /sys/block/zram0/mem_limit      &&
      echo "${anon_min}"   > /proc/sys/vm/anon_min_kbytes    &&
      echo "${cln_min}"    > /proc/sys/vm/clean_min_kbytes   &&
      echo "${cln_low}"    > /proc/sys/vm/clean_low_kbytes   &&
      echo "${swpns}"      > /proc/sys/vm/swappiness         &&
      echo "${vfs_cps}"    > /proc/sys/vm/vfs_cache_pressure &&
      echo "${wtrm_sf}"    > /proc/sys/vm/watermark_scale_factor
     evalret

     ainitsvc "swap" "creating and enabling zram as swap"
      mkswap -L zram0 /dev/zram0 >/dev/null 2>&1 &&
      swapon -p 100   /dev/zram0
     evalret
     ;;
     swapfile)
     checkswaps

     if [ ! -f "${swappath}" ]
      then
       ainitsvc "swap" "swapfile not found, creating"
        for i in "${swappath}"; do
         dd if=/dev/zero of="${i}" \
          count="${swapsize}" bs=1M conv=notrunc >/dev/null 2>&1 &&
         mkswap -L "apathy_swapfile"      "${i}" >/dev/null 2>&1 &&
         chown root:root                  "${i}"            &&
         chmod 0600                       "${i}"
        done
       evalret
      else
       ainitsvc "swap" "setting up sysfs/procfs for swapfile as swap"
        echo "0"   > /proc/sys/vm/anon_min_kbytes    &&
        echo "0"   > /proc/sys/vm/clean_min_kbytes   &&
        echo "0"   > /proc/sys/vm/clean_low_kbytes   &&
        echo "60"  > /proc/sys/vm/swappiness         &&
        echo "100" > /proc/sys/vm/vfs_cache_pressure &&
        echo "10"  > /proc/sys/vm/watermark_scale_factor
       evalret
     fi

     ainitsvc "swap" "enabling swapfile as swap"
      swapon -p 100 "${swappath}"
     evalret
    ;;
    *)
     ainitmes "specify either zram or swapfile as \$2."; failprompt
     exit 1
    ;;
   esac
  ;;
  stop)
   checkswaps
  ;;
  *)
   ainitusage "{start|stop}"
   exit 1
  ;;
 esac
}

# 2.11 > acpid
svc_acpid(){
case "$1" in
 start)
  ainitsvc "acpid" "starting"
   acpid -n -S -f -c /mss/init/files/acpi >/dev/null 2>&1 &
  evalret
 ;;
 stop)
  ainitsvc "acpid" "stopping"
  ainit_kill acpid
 ;;
 *)
  ainitusage "{start|stop}"
  exit 1
 ;;
esac
}
